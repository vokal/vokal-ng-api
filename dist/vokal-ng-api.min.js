/*! vokal-ng-api Copyright Vokal 2017 */
!function(a,b){"function"==typeof define&&define.amd?define("vokal-ng-api",["humps"],function(a){return b(a)}):"object"==typeof module&&module.exports?module.exports=b(require("humps")):b(a.humps)}(this,function(a){angular.module("vokal.API",["vokal.Humps"]).factory("API",["$http","$rootScope","$q","$location","$timeout","Humps",function(b,c,d,e,f,g){"use strict";function h(a){try{return decodeURIComponent(a)}catch(a){}}function i(a){var b,c,d={};return angular.forEach((a||"").split("&"),function(a){if(a&&(b=a.replace(/\+/g,"%20").split("="),c=h(b[0]),angular.isDefined(c))){var e=!angular.isDefined(b[1])||h(b[1]);hasOwnProperty.call(d,c)?angular.isArray(d[c])?d[c].push(e):d[c]=[d[c],e]:d[c]=e}}),d}function j(a){return encodeURIComponent(a).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%3B/gi,";").replace(/%20/g,"+").replace(/%7B/g,"{").replace(/%7D/g,"}").replace(/%5B/g,"[").replace(/%5D/g,"]").replace(/%22/g,'"').replace(/%5C/g,"\\")}var k=!1,l=!1,m=[],n=[],o=!1,p=function(a){var b=a.split("?");return 1===b.length?{}:i(b[1])},q=function(b,c,d){if(!angular.isObject(c))return b;c=angular.extend({},p(b),c||{}),d&&d.transformHumps&&(c=a.decamelizeKeys(c,{separator:"_"})),b=b.split("?")[0];for(var e=Object.keys(c),f=[],g=0;g<e.length;g++){var h=e[g],i=c[h];angular.isObject(i)&&(i=JSON.stringify(i)),f.push(j(h)+"="+j(i))}return b+(f.length?"?"+f.join("&"):"")},r=function(a,b){return angular.isString(a)?a===b:!!angular.isArray(a)&&a.indexOf(b)>-1},s=function(a){this.globalHeaders=angular.copy(this.constructor.prototype.globalHeaders),a&&(void 0!==a.name&&(this.name=a.name),void 0!==a.globalHeaders&&(this.globalHeaders=angular.copy(a.globalHeaders)),void 0!==a.rootPath&&(this.rootPath=a.rootPath),void 0!==a.keyName&&(this.keyName=a.keyName),void 0!==a.transformHumps&&(this.transformHumps=a.transformHumps),void 0!==a.cancelOnRouteChange&&(this.cancelOnRouteChange=a.cancelOnRouteChange),void 0!==a.unauthorizedInterrupt&&(this.unauthorizedInterrupt=a.unauthorizedInterrupt),void 0!==a.loginPath&&(this.loginPath=a.loginPath),void 0!==a.loginRoutes&&(this.loginRoutes=a.loginRoutes))};return s.prototype.name="",s.prototype.globalHeaders={},s.prototype.rootPath="",s.prototype.keyName="Authorization",s.prototype.transformHumps=!0,s.prototype.cancelOnRouteChange=!1,s.prototype.unauthorizedInterrupt=!1,s.prototype.loginPath=null,s.prototype.loginRoutes=null,s.prototype.extendHeaders=function(a){angular.extend(this.globalHeaders,a)},s.prototype.setKey=function(a){this.globalHeaders[this.keyName]="string"==typeof a?a:"","string"!=typeof a&&void 0!==a&&null!==a&&console.warn("setKey( key ) only accepts a String for parameter key")},s.prototype.getKey=function(){return this.globalHeaders[this.keyName]},s.prototype.queryUrl=q,s.prototype.apiRequest=function(a,h,i,j){var p=this,q=d.defer(),s=d.defer(),t={method:a,url:this.rootPath+h,headers:this.globalHeaders,data:i||{},timeout:s.promise,ngName:this.name};if("postFile"===a?(this.globalHeaders["Content-Type"]=void 0,t.method="post",t.transformRequest=angular.identity):this.transformHumps&&(this.globalHeaders["Content-Type"]="application/json",t.transformRequest=g.requestToSnake(b.defaults.transformRequest),t.transformResponse=g.responseToCamel(b.defaults.transformResponse)),b(t).then(function(a){var b=a.data,d=a.status;c.$broadcast("APIRequestComplete",t,b,d),c.$broadcast("APIRequestSuccess",t,b,d),q.resolve({data:b,options:t,status:d})},function(b){var g=b.data,s=b.status;if(q.promise.$canceling||c.$broadcast("APIRequestComplete",t,g,s),!l&&401===s&&e.path()!==p.loginPath&&!r(p.loginRoutes,h)){if(k||j){if(j){c.$broadcast("APIRequestUnauthorized",t,g,s);for(var u=0;u<n.length;u++)n[u].promise.$cancel("Request canceled due to authorization failure",t);o=!1,k=!1,m=[],n=[]}else o?p.repeatRequest({method:a,path:h,requestData:i,promise:q}):(m.push({method:a,path:h,requestData:i,promise:q}),n.push(q));return}if(p.unauthorizedInterrupt===!0)return void c.$broadcast("APIRequestUnauthorized",t,g,s);if("function"==typeof p.unauthorizedInterrupt)return k=!0,m.push({method:a,path:h,requestData:i,promise:q}),n.push(q),void f(function(){l=!0,p.unauthorizedInterrupt(g,t,s).then(function(){l=!1,o=!0,d.all(n).finally(function(){o=!1,k=!1,m=[],n=[]});for(var a=0;a<m.length;a++)p.repeatRequest(m[a])},function(a){l=!1,k=!1,m=[],n=[],c.$broadcast("APIAuthorizationFailure",a||"",t)})},0);c.$broadcast("APIRequestUnauthorized",t,g,s)}q.promise.$canceling||(c.$broadcast("APIRequestError",t,g,s),q.reject({data:g,options:t,status:s}))}),c.$broadcast("APIRequestStart",t),this.cancelOnRouteChange)var u=c.$on("$routeChangeSuccess",function(){q.promise.$cancel("Request canceled",t),u()}),v=c.$on("APIRequestComplete",function(){u(),v()});return q.promise.$cancel=function(a,b,d){q.promise.$canceling=!0,s.resolve(),c.$broadcast("APIRequestCanceled",b,a),d&&q.reject({data:a||"Request canceled",options:b})},q.promise},s.prototype.resetAuthResolution=function(){k=!1,l=!1,m=[],n=[],o=!1},s.prototype.$get=function(a,b){return this.apiRequest("get",q(a,b,{transformHumps:this.transformHumps}))},s.prototype.$post=function(a,b){return this.apiRequest("post",a,b)},s.prototype.$postFile=function(a,b){return this.apiRequest("postFile",a,b)},s.prototype.$put=function(a,b){return this.apiRequest("put",a,b)},s.prototype.$patch=function(a,b){return this.apiRequest("patch",a,b)},s.prototype.$delete=function(a){return this.apiRequest("delete",a)},s.prototype.repeatRequest=function(a){this.apiRequest(a.method,a.path,a.requestData,!0).then(function(b){a.promise.resolve({data:b.data,options:b.options,status:b.status})},function(b){a.promise.reject({data:b.data,options:b.options,status:b.status})})},s}]),angular.module("vokal.Humps",[]).service("Humps",function(){"use strict";var b=function(a,b){return a=angular.isArray(a)?a:[a],a.concat(b)};this.responseToCamel=function(c){return b(c,function(b){return a.camelizeKeys(b)})},this.requestToSnake=function(c){return b(c,function(b){return"string"==typeof b?JSON.stringify(a.decamelizeKeys(JSON.parse(b),{separator:"_"})):a.decamelizeKeys(b,{separator:"_"})})}})});